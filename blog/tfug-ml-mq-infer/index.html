<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>~/arindas • Message Queue: Function and Role in ML Inference</title><link href=/favicon.ico rel=icon type=image/png><link href=https://arindas.github.io/atom.xml rel=alternate title=~/arindas type=application/atom+xml><link href=https://arindas.github.io/custom_subset.css rel=stylesheet><link href=https://arindas.github.io/main.css media=screen rel=stylesheet><meta content="light dark" name=color-scheme><meta content="A post discussing the role of message queues in multistage horizontally scalable ML inference. Originally written for a talk at TFUG Kolkata." name=description><meta content="A post discussing the role of message queues in multistage horizontally scalable ML inference. Originally written for a talk at TFUG Kolkata." property=og:description><meta content="index, nofollow" name=robots><meta content="~/arindas • Message Queue: Function and Role in ML Inference" property=og:title><meta content=article property=og:type><meta content=https://raw.githubusercontent.com/arindas/tfug-ml-mq-infer/main/assets/multi-stage-processing.drawio.png property=og:image><meta content=https://raw.githubusercontent.com/arindas/tfug-ml-mq-infer/main/assets/multi-stage-processing.drawio.png name=twitter:card><meta content=https://arindas.github.io/blog/tfug-ml-mq-infer/ property=og:url><meta content=~/arindas property=og:site_name><meta content="default-src 'self';
        
        
        
        
        

        font-src 'self' data:;img-src 'self' https://* data:;script-src 'self' giscus.app;style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com giscus.app" http-equiv=Content-Security-Policy><script src=https://arindas.github.io/js/initializeTheme.min.js></script><script defer src=https://arindas.github.io/js/themeSwitcher.min.js></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://arindas.github.io>~/arindas</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://arindas.github.io/blog/>blog</a><li><a class="nav-links no-hover-padding" href=https://arindas.github.io/archive/>archive</a><li><a class="nav-links no-hover-padding" href=https://arindas.github.io/tags/>tags</a><li><a class="nav-links no-hover-padding" href=https://arindas.github.io/projects/>projects</a><li><a class="nav-links no-hover-padding" href=https://arindas.github.io/about/>about</a><li class=theme-switcher-wrapper><div class=theme-switcher></div></ul></div></nav></header><div class=content><main><article><div class=article-title>Message Queue: Function and Role in ML Inference</div><ul class=meta><li>18th Jun 2023 •<li title="3562 words "> 18 min read<li> • Tags: <li><a href=https://arindas.github.io/tags/mlops/>mlops</a>, <li><a href=https://arindas.github.io/tags/message-queue/>message-queue</a>, <li><a href=https://arindas.github.io/tags/ml-inference/>ml-inference</a></ul><div class=toc-container><h3>Table of Contents</h3><ul><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#introduction>Introduction</a><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#message-queue-usage-model>Message queue usage model</a> <ul><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#background-client-server-model>Background: Client Server model</a><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#message-queue-asynchronous-processing>Message Queue: Asynchronous processing</a><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#message-queue-multi-stage-horizontally-scalable-asynchronous-processing>Message Queue: Multi-stage horizontally scalable asynchronous processing</a> <ul><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#apache-kafka>Apache Kafka</a><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#google-cloud-pub-sub>Google Cloud Pub/Sub</a></ul><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#primary-distinction-between-synchronous-and-asynchronous-request-processing>Primary distinction between synchronous and asynchronous request processing</a></ul><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#why-use-message-queues-instead-of-databases>Why use message queues instead of Databases?</a><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#case-study-plant-medicine-effectiveness-on-crops>Case Study: Plant medicine effectiveness on Crops</a> <ul><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#solution-architecture>Solution Architecture</a> <ul><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#drone-image-collector>Drone Image Collector</a><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#leaf-image-cropper>Leaf image cropper</a><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#disease-demultiplexer-service>Disease demultiplexer service</a><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#individual-disease-grader-services>Individual disease grader services</a><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#data-analysis>Data Analysis</a><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#audits-and-reproducibility>Audits and Reproducibility</a><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#scaling-up-horizontally>Scaling up horizontally</a><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#support-for-multiple-environments>Support for multiple environments</a></ul></ul><li><a href=https://arindas.github.io/blog/tfug-ml-mq-infer/#conclusion>Conclusion</a></ul></div><section class=body><p><em>This was originally written for a talk at TFUG Kolkata. Read the slides <a href=https://raw.githubusercontent.com/arindas/tfug-ml-mq-infer/main/tfug-ml-mq-infer-slides.pdf rel=noopener target=_blank>here</a>.</em><h2 id=introduction><a aria-label="Anchor link for: introduction" class="header-anchor no-hover-padding" href=#introduction><span aria-hidden=true class=link-icon></span></a> Introduction</h2><p>Let's first talk a bit about message queues.<p>We see the word "queue" in it, why?<p align=center><img alt=queue-diagram src=https://raw.githubusercontent.com/arindas/tfug-ml-mq-infer/main/assets/queue.drawio.png><p align=center class=caption><b>Fig:</b> a First In First Out (FIFO) queue.<p>A queue is a first in first out data-structure for storing a set of elements.<p>However this definition doesn't tell us anything about:<ul><li>How and where the elements are stored (in-memory, hard disk etc.)<li>Who can access this queue from where</ul><p>In the 21st century, we have the following additional requirements:<ul><li>It has to be accessible over the internet over well known protocols (HTTP, gRPC etc.)<li>It might need to implement role base access control (RBAC)<li>It has to be persistent if necessary<li>It has to be replicated to be highly available.<li>All replicas need to be consistent with each other<li>It has to support multiple channels for different types of elements<li>It has to be reasonably fast<li>We can't be bothered about these requirements. We have business requirements to worry about</ul><p>Message queues are queues of "message" elements, and they fulfil the above requirements.<h2 id=message-queue-usage-model><a aria-label="Anchor link for: message-queue-usage-model" class="header-anchor no-hover-padding" href=#message-queue-usage-model><span aria-hidden=true class=link-icon></span></a> Message queue usage model</h2><p>This section discusses the models of computations possible using message queues.<h3 id=background-client-server-model><a aria-label="Anchor link for: background-client-server-model" class="header-anchor no-hover-padding" href=#background-client-server-model><span aria-hidden=true class=link-icon></span></a> Background: Client Server model</h3><p>Let us first discuss how we work without message queues.<p>In the conventional client server model, the client makes synchronous requests to the server, which responds back with a synchronous response.<p align=center><img alt=client-server-model src=https://raw.githubusercontent.com/arindas/tfug-ml-mq-infer/main/assets/client-server-model.drawio.png><p align=center class=caption><b>Fig:</b> Client - Server model.<p>What happens when we have too many clients that the server can't handle at once?<p align=center><img alt=client-server-model-overwhelmed src=https://raw.githubusercontent.com/arindas/tfug-ml-mq-infer/main/assets/client-server-model-overwhelmed.drawio.png><p align=center class=caption><b>Fig:</b> Client - Server model overhelmed with too many clients for the server to handle.<p>The server is simply unable to service all the clients within a reasonable time. Either the requests time out completely, or the server starts refusing connections when the maximum number of connections is reached. The server may also be also be configured with request rate limits where the server start dropping requests altogether if they arrive at a higher than expected rate.<h3 id=message-queue-asynchronous-processing><a aria-label="Anchor link for: message-queue-asynchronous-processing" class="header-anchor no-hover-padding" href=#message-queue-asynchronous-processing><span aria-hidden=true class=link-icon></span></a> Message Queue: Asynchronous processing</h3><p>Message queues enable asynchronous handling of requests.<p align=center><img alt=async-processing src=https://raw.githubusercontent.com/arindas/tfug-ml-mq-infer/main/assets/async-processing.drawio.png><p align=center class=caption><b>Fig:</b> Asynchronous processing of requests with request and response queues.<p>Asynchronous processing allows the server to actually handle all the requests without timing out or refusing connections. However in this case, the responses are available later at a different time, as opposed to client - server model where responses are available synchronously.<p>However, this is not the only thing that message queues are good at. Message queues also enable large scale request handling with <em>multiple stages</em>, and <em>horizontal scaling</em> at each stage. But how?<h3 id=message-queue-multi-stage-horizontally-scalable-asynchronous-processing><a aria-label="Anchor link for: message-queue-multi-stage-horizontally-scalable-asynchronous-processing" class="header-anchor no-hover-padding" href=#message-queue-multi-stage-horizontally-scalable-asynchronous-processing><span aria-hidden=true class=link-icon></span></a> Message Queue: Multi-stage horizontally scalable asynchronous processing</h3><p align=center><img alt=multi-stage-processing src=https://raw.githubusercontent.com/arindas/tfug-ml-mq-infer/main/assets/multi-stage-processing.drawio.png><p align=center class=caption><b>Fig:</b> Multi-stage asynchornous horizontally scalable processing.<p>In the above figure, we have to stages of computation <code>stage #a</code> and <code>stage #b</code>. There are two sets of servers for hosting these stages of computation. These two stages are connected to each other with message queue topics. This architecture works as follows:<ul><li>Client pushes a message containing the input request to be processed into the first topic <code>topic_a_in</code><li>The <code>stage #a</code> server pulls in messages from the <code>topic_a_in</code> topic, processes it and writes the intermediate result to <code>topic_a_out_b_in</code> topic.<li>The <code>stage #b</code> server pulls in intermeidate processed results from the <code>topic_a_out_b_in</code> topic, processes them and writes the final output to <code>topic_b_out</code> topic.<li>The client reads the results from the <code>topic_b_out</code> topic.</ul><p>You may also think of the <code>stage #a</code> and <code>stage #b</code> as two functions $a(x)$ and $b(x)$, and we are essentially computing the composite function $(b \circ a)(x) = b(a(x))$ where $x$ is the client input request. The difference being:<ul><li>The values are passed into the "function"(s) over the network via message queues<li>There is a queue of values $X = \lbrace x_0, x_1, ...\rbrace $ to process.<li>The invocation at every stage can be done in parallel with the stage replicas. The message queue is responsible for adequately load balancing the elements from the queue among all the replicas.</ul><p>Now in order to see, how this load balancing is done in practice, let's take a look at two popular message queuing solutions:<ul><li>Apache Kafka<li>Google Cloud Pub/Sub</ul><h4 id=apache-kafka><a aria-label="Anchor link for: apache-kafka" class="header-anchor no-hover-padding" href=#apache-kafka><span aria-hidden=true class=link-icon></span></a> Apache Kafka</h4><p>In Apache Kafka, messages are organized by "topic"(s). Each "topic" is further broken down partitions. Messages in a partition are ordered and isolated from messages in another partition.<p align=center><img alt=topic-partition-hierarchy src=https://raw.githubusercontent.com/arindas/tfug-ml-mq-infer/main/assets/kafka-topic-partition.drawio.png><p align=center class=caption><b>Fig:</b> Topics and partitions in Apache Kafka.<p>There are two kinds of clients for Apache Kafka: Producers and Consumers<ul><li>Producers produce messages into a topic in Kafka. They can choose to write to a particular partition or let Kafka load balance messages to a partition.<li>Consumers consume message from a particular partition under a topic.</ul><p align=center><img alt=kafka-horizontal-scaling src=https://raw.githubusercontent.com/arindas/tfug-ml-mq-infer/main/assets/kafka-horizontal-scaling.drawio.png><p align=center class=caption><b>Fig:</b> Horizontally scaling a stage with Kafka partitions.<p>In our multistage computation example, each stage has input request and output responses. Let's assign a particular topic to a particular stage. To achieve horizontal scaling we do the following:<ul><li>We make multiple partitions under the topic for this stage.<li>We write input requests to the topic. The partitioner load balances the messages to the partitions under this topic.<li>We run multiple instances of the request hander for this stage. Each stage contains a consumer which reads from a particular partition.<li>In order to horizontally scale up further, we increase the number of partitions and request handler instances.</ul><h4 id=google-cloud-pub-sub><a aria-label="Anchor link for: google-cloud-pub-sub" class="header-anchor no-hover-padding" href=#google-cloud-pub-sub><span aria-hidden=true class=link-icon></span></a> Google Cloud Pub/Sub</h4><p>Google Cloud Pub/Sub makes this a bit more simpler. There are "topic"(s) where messages are written to. Each "topic" can have a set of "subscription"(s). There can be multiple publishers to a topic, and multiple subscribers that read from multiple subscriptions from the topic.<p>Message published to the topic are load balanced across all the subscriptions.<h3 id=primary-distinction-between-synchronous-and-asynchronous-request-processing><a aria-label="Anchor link for: primary-distinction-between-synchronous-and-asynchronous-request-processing" class="header-anchor no-hover-padding" href=#primary-distinction-between-synchronous-and-asynchronous-request-processing><span aria-hidden=true class=link-icon></span></a> Primary distinction between synchronous and asynchronous request processing</h3><ul><li>Synchronous model: Requests are delivered to the server as soon as they arrive. If the server has enough resources to handle the requests, they are processed. Otherwise they are either delayed or dropped.<li>Asynchronous model: Requests are buffered as soon as they arrive. Then the server pulls a request from the buffered queue of requests when it has enough resources to handle the request. This improved the success rate of requests being handled successfully.</ul><blockquote><p>Some also call this event driven architecture, with the individual messages being "event"(s)</blockquote><h2 id=why-use-message-queues-instead-of-databases><a aria-label="Anchor link for: why-use-message-queues-instead-of-databases" class="header-anchor no-hover-padding" href=#why-use-message-queues-instead-of-databases><span aria-hidden=true class=link-icon></span></a> Why use message queues instead of Databases?</h2><p>Why don't we use different tables for representing topics? Each row could be a message. We could use a partitioning function like modulus to partition the topic for horizontal scaling.<p>You can indeed do this, some production systems use databases instead of message queues in this manner.<p>However message queues have some advantages over traditional data bases:<p align=center><img alt=segmented-log src=https://raw.githubusercontent.com/arindas/tfug-ml-mq-infer/main/assets/segmented-log.drawio.png><p align=center class=caption><b>Fig:</b> The <code>segmented-log</code> data-structure.<ul><li>Message queues use different data structures for storage and indexing. Message queues use <code>segmented_log</code>(s), while traditional relational databases use data-structures from the <code>B-Tree</code> family<li><code>segmented_log</code> and <code>B-Tree</code> performance comparison: <ul><li><code>segmented_log</code>(s) have $O(1)$ writes on average. <code>B-Tree</code>(s) have $O(\log n)$ insertions. <ul><li>In segmented_log appending to the <code>write_segment</code> is $O(1)$<li>When rotating the <code>write_segment</code>, <code>vector::push_back</code> on vector of read segments is $O(1)$ on average, $O(|segments|)$ at worst.<li>Modern vector implementations ensure that the worst case of having to copy all the elements when pushing back to end of the vector is very rare. They may employ the following approaches: <ul><li>Exponential memory reservation when reserving more memory<li>Maintaining multiple disjoint contiguous slabs of memory to avoid having to copy elements when reserving more memory. New elements are written to the last memory slab. This reduces worst case for push_back to almost $O(1)$ on average. Reads are still $O(1)$ since the memory region for any index can be easily computed as all elements have same size and the regions are identical in size.</ul></ul><li><code>segmented_log</code>(s) can guarantee $O(\log |segments|)$ reads while B-Trees have $O(\log n)$ reads, where $n$ is the total number of records and $segments$ is the set of segments in the segmented_log. (Usually, $\frac{n}{|segments|} >= 1000$) <ul><li>This is possible since the segments are sorted by indices and given a record index, we can perform a binary search to check which segment has the record with the index, which would be $O(\log |segments|)$. Reading at a specific index from a segment is $O(1)$.<li>If we can guarantee constant record size (with padding) and constant max number of records per segment, we can provide $O(1)$ reads for <code>segmented_log</code>(s). This would be possible because determining which segment has the index would also be a $O(1)$ in this case.</ul></ul></ul><p align=center><img alt=B-Tree src=https://raw.githubusercontent.com/arindas/tfug-ml-mq-infer/main/assets/b-tree.png><p align=center class=caption><b>Fig:</b> The <code>B-Tree</code> data-structure.<ul><li><code>segmented_log</code> and <code>B-Tree</code> comparison continued ... <ul><li><code>segmented_log</code>(s) have far lesser number of memory indirections than <code>B-Tree(s)</code> when simply sequentially iterating over the elements. (Trees have multiple levels of pointer indirection, as opposed to vectors which have contiguous memory allocation and are very cache-friendly). Higher number of memory indirections increase the number of virtual memory page faults and decrease cache locality.<li><code>segmented_log</code>(s) have higher disk page locality. This due to <code>segmented_log</code>'s append only nature where writes always go to the end of the files, which is optimal for disk page cache.<li><code>segmented_log</code>(s) are highly optimized on SSDs due to it's sequential append only write characteristics<li><strong>In conclusion, <code>segmented_log</code>(s) support much faster writes and reads than <code>B-Tree</code>(s), on average.</strong></ul><li>Modern databases that are based on <code>LSM trees</code> (Google BigTable, Google Spanner, Cassandra, DynamoDB, TiKV, Redis) have similar performance characteristics to <code>segmented_log</code>(s)<li>Message queues don't require a query parsing and execution layer for accessing messages.<li>Writes in databases often require transactions for atomicity and consistency guarantees. For distributed databases, there are distributed transactions with sophisticated protocols like two phase commit which blocks on failure. Message queues can rely on consensus algorithms like Raft and Paxos for consistency between replicas, which are non-blocking and more resilient to failures.<li>Message queues have been explicitly designed to provide queue like semantics. One has to build additional abstractions over databases to obtain message queue like behaviour.</ul><p>However, the gaps between message queues and databases are gradually decreasing. Apache Kafka now provides an SQL like query layer for stream analytics. In-memory key value stores (databases) like Redis also provide message queue abstractions out of the box.</p><br><hr><p>Remember that this talk was actually about Machine Learning inference with message queues and not just about message queues. To illustrate how message queues might be used in a machine learning inference system in the real world, consider the following case study.<hr><br><h2 id=case-study-plant-medicine-effectiveness-on-crops><a aria-label="Anchor link for: case-study-plant-medicine-effectiveness-on-crops" class="header-anchor no-hover-padding" href=#case-study-plant-medicine-effectiveness-on-crops><span aria-hidden=true class=link-icon></span></a> Case Study: Plant medicine effectiveness on Crops</h2><blockquote><p>An agricultural pharmacy company has come up with a new drug to cure various plant diseases. Now, they wish to measure the effectiveness of their medicine. They want to quantitatively analyze if the medicine speeds up the healing process in plants.<p>In order to to do this, the company partners with a farm owner to test out the medicine on their crops. They isolate the farm into two areas, the control area where no medicine is used and the active area where the newly developed medicine is tested out. They decide on a uniform medicine distribution quantity, let's say 120 ml/sqft.<p>Now they employ a fleet of drones to regularly take images of the plants in the farm in both the control and active areas to keep track of the health of the plants. The drones take photographs of the plants in the farm at regular distances to cover the entire farm. The trajectory of the drones are preprogrammed in such way that each drones always take photographs at some specific positions (marked by GPS) and each photograph contains a maximum of 20 leaves. The drones take photographs at regular time intervals (e.g daily)<p>(The plants are in a green house. They don't move around a lot due to absence of wind)<p>The Machine Learning engineers are to analyze the photographs taken by the drones and measure the effect of the medicine on the leaves.</blockquote><p>Now take a look at this photograph:<p align=center><img src="https://media.istockphoto.com/id/483451251/photo/fungal-attack.jpg?s=612x612&w=0&k=20&c=PM0Lld99Io4DU6sRqemkytZUkuSF5effOJ8fhIAXwVo=" alt=fungal-attack><p align=center class=caption><b>Fig:</b> A plant suffering from a fungal-attack.<p>Intuitively it makes sense that if the disease progresses, the disease affected area will spread and increase. If it heals, the disease area will decrease.<p>The excellent machine learning engineers in this room would agree that approaching this problem with semantic segmentation would be powerful. From a single image with multiple leaves, multiple disease types can be detected along with the area covered by each type.<p>However that is an ideal case. It is only possible if you have the required datasets.<p>The machine learning engineers only have the following datasets:<ul><li>Leaf object detection dataset<li>Disease grade classification for 5 diseases (the grades correspond to severity)</ul><p>There are no sufficiently large annotated semantic segmentation dataset that can be used for production purposes. (Let's say, for this scenario.)<h3 id=solution-architecture><a aria-label="Anchor link for: solution-architecture" class="header-anchor no-hover-padding" href=#solution-architecture><span aria-hidden=true class=link-icon></span></a> Solution Architecture</h3><p>The machine learning engineers provide the following models:<ul><li>A leaf object detector<li>5 disease grade classifier models. Each disease grade classifier models has 4 classes.</ul><p>The software engineers design the solution with a suite of micro-services and drone controllers which communicate with each other using the message queue.<p align=center><img alt=plant-pharma-case-study-solution-architecture src=https://raw.githubusercontent.com/arindas/tfug-ml-mq-infer/main/assets/plant-pharma-case-study-solution-architecture.drawio.png><p align=center class=caption><b>Fig:</b> Solution Architecture diagram.<p>The main steps are as follows:<ul><li>Leaf obj detection on plant image<li>Leaf bounding box detection<li>Leaf image Crop from detected bounding boxes<li>Disease grade classification on individual cropped leaf images<li>Store prediction in DB<li>Aggregate Queries for insights</ul><p>The various components of the system are described in the following sections.<h4 id=drone-image-collector><a aria-label="Anchor link for: drone-image-collector" class="header-anchor no-hover-padding" href=#drone-image-collector><span aria-hidden=true class=link-icon></span></a> Drone Image Collector</h4><p>The drone moves to specific position clicks an image, and uploads it to an S3/GCS bucket at a specific path. Each drone position has a unique identifier. The image path could be of the form:<pre class=z-code><code><span class="z-text z-plain">s3://${STORAGE_BUCKET}/${position_id}/${date}/image.png
</span></code></pre><p>Next the drone controller produces a message on the "drone_image" topic. The message simply contains the S3 image object path.<p>We assume that the drones are equipped with some form of internet connectivity.<blockquote><p>In the following section, when I say that a components consumes a message, if the message contains an image url, assume that the component also downloads the image from the url to it's local storage.<p>Also the service might use a shared persistent storage service to avoid hitting S3 every time.</blockquote><h4 id=leaf-image-cropper><a aria-label="Anchor link for: leaf-image-cropper" class="header-anchor no-hover-padding" href=#leaf-image-cropper><span aria-hidden=true class=link-icon></span></a> Leaf image cropper</h4><p>The leaf image cropper crops out the leaves from the drone image using the leaf object detection model.<p>The leaf object detection is model is served with a model serving solution like "Tensorflow serving" or "PyTorch serve". The model serving solution provides the model inference at specific HTTP or gRPC endpoint.<p>The leaf image cropper has a consumer to consume drone image from the "drone_image" topic. It then perform inference with the HTTP or gRPC endpoint served by the model serving solution and obtains all the bounding boxes. It then uses bounding boxes to crop out the leaves.<p>For each cropped out leaf:<ul><li><p>A new cropped leaf image is created. It is uploaded to:</p> <pre class=z-code><code><span class="z-text z-plain">s3://${STORAGE_BUCKET}/${position_id}/${date}/${cropper-model-id}/${cropper-model-version}/${leaf_crop_idx}.png
</span></code></pre><li><p>It produces a message on the "cropped_leaf" topic. The message contains the above S3 image object path.</p></ul><h4 id=disease-demultiplexer-service><a aria-label="Anchor link for: disease-demultiplexer-service" class="header-anchor no-hover-padding" href=#disease-demultiplexer-service><span aria-hidden=true class=link-icon></span></a> Disease demultiplexer service</h4><p>This service simply consumes a message from the "cropped_leaf" and produces it on each of the 5 disease grader topics "disease_0", "disease_1", ..., "disease_4".<p>This service might not be necessary in some message queues where they provide utilities to do this automatically.<h4 id=individual-disease-grader-services><a aria-label="Anchor link for: individual-disease-grader-services" class="header-anchor no-hover-padding" href=#individual-disease-grader-services><span aria-hidden=true class=link-icon></span></a> Individual disease grader services</h4><p>Each disease has 4 grades with 0 for healthy and 4 for most severe.<p>A disease grader service uses it's corresponding disease grading model to grade the severity of the cropped leaf for the corresponding disease.<p>The "disease_#n" grader model is served with a model serving solution like "Tensorflow serving" or "PyTorch serve". The model serving solution provides the model inference at specific HTTP or gRPC endpoint.<p>A disease grader service consumes a cropped leaf image from it's corresponding input topic, performs inference with the HTTP or gRPC endpoint exposed by the model serving solution, and writes a record with the following schema to a database:<pre class="language-json z-code" data-lang=json><code class=language-json data-lang=json><span class="z-source z-json"><span class="z-meta z-mapping z-json"><span class="z-punctuation z-section z-mapping z-begin z-json">{</span>
  <span class="z-invalid z-illegal z-expected-mapping-key z-json">p</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">s</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">i</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">t</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">i</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">n</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">_</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">i</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-invalid z-illegal z-expected-mapping-separator z-json">…</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">,</span> <span class="z-comment z-line z-double-slash z-js"><span class="z-punctuation z-definition z-comment z-json">//</span> drone position on field
</span>  <span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">a</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">t</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-invalid z-illegal z-expected-mapping-separator z-json">…</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">,</span> <span class="z-comment z-line z-double-slash z-js"><span class="z-punctuation z-definition z-comment z-json">//</span> date on which image was taken
</span>  <span class="z-invalid z-illegal z-expected-mapping-key z-json">l</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">a</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">f</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">_</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">c</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">r</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">p</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">_</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">i</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">x</span><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-invalid z-illegal z-expected-mapping-separator z-json">…</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">,</span> <span class="z-comment z-line z-double-slash z-js"><span class="z-punctuation z-definition z-comment z-json">//</span> leaf crop index from leaf crops with obj. det. model
</span>  <span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">i</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">s</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">a</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">s</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">_</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">t</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">y</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">p</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-invalid z-illegal z-expected-mapping-separator z-json">…</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">,</span> <span class="z-comment z-line z-double-slash z-js"><span class="z-punctuation z-definition z-comment z-json">//</span> disease grader disease type
</span>  <span class="z-invalid z-illegal z-expected-mapping-key z-json">p</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">r</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">i</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">c</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">t</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">_</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">g</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">r</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">a</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-invalid z-illegal z-expected-mapping-separator z-json">…</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">,</span> <span class="z-comment z-line z-double-slash z-js"><span class="z-punctuation z-definition z-comment z-json">//</span> predicted disease severity grade
</span>  <span class="z-invalid z-illegal z-expected-mapping-key z-json">c</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">r</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">p</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">p</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">r</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">_</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">m</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">l</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">_</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">i</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-invalid z-illegal z-expected-mapping-separator z-json">…</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">,</span> <span class="z-comment z-line z-double-slash z-js"><span class="z-punctuation z-definition z-comment z-json">//</span> model used for cropping
</span>  <span class="z-invalid z-illegal z-expected-mapping-key z-json">c</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">r</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">p</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">p</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">r</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">_</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">m</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">l</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">_</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">v</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">r</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">s</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">i</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">n</span><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-invalid z-illegal z-expected-mapping-separator z-json">…</span> <span class="z-comment z-line z-double-slash z-js"><span class="z-punctuation z-definition z-comment z-json">//</span> version of cropper model used
</span>  <span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">i</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">s</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">a</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">s</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">_</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">m</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">l</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">_</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">i</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-invalid z-illegal z-expected-mapping-separator z-json">…</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">,</span> <span class="z-comment z-line z-double-slash z-js"><span class="z-punctuation z-definition z-comment z-json">//</span> model used for predicting disease
</span>  <span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">i</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">s</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">a</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">s</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">_</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">m</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">d</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">l</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">_</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">v</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">e</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">r</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">s</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">i</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">o</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">n</span><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-invalid z-illegal z-expected-mapping-separator z-json">…</span><span class="z-invalid z-illegal z-expected-mapping-key z-json">,</span> <span class="z-comment z-line z-double-slash z-js"><span class="z-punctuation z-definition z-comment z-json">//</span> version of the disease predictor model used
</span><span class="z-punctuation z-section z-mapping z-end z-json">}</span></span>
</span></code></pre><h4 id=data-analysis><a aria-label="Anchor link for: data-analysis" class="header-anchor no-hover-padding" href=#data-analysis><span aria-hidden=true class=link-icon></span></a> Data Analysis</h4><p>Once we have the leaf disease prediction data, a competent Data Analyst can use different analytical queries to obtain insights about the efficiency of the medicine. There can also be an analytical service which runs in the background and recomputes a set of analytical queries to maintain a set of dashboards.<h4 id=audits-and-reproducibility><a aria-label="Anchor link for: audits-and-reproducibility" class="header-anchor no-hover-padding" href=#audits-and-reproducibility><span aria-hidden=true class=link-icon></span></a> Audits and Reproducibility</h4><p>You might have observed that we also store the model id and version with each record. This is necessary if we need to re-analyze with different versions of different models.<p>We can regenerate all the messages by walking over the contents of the message queue and the system will perform inference as necessary. However, some message queues (like Apache Kafka) also allow you to replay messages.<p>For instance, consider we updated the model for "disease_3" and we want to re-analyze the images. We may simply replay the messages in the topic for "disease_3" along with new model config for the corresponding disease grader service. This will produce new disease inference records with the appropriate model details.<h4 id=scaling-up-horizontally><a aria-label="Anchor link for: scaling-up-horizontally" class="header-anchor no-hover-padding" href=#scaling-up-horizontally><span aria-hidden=true class=link-icon></span></a> Scaling up horizontally</h4><p>Now as discussed toward the start of the talk, individual services can be horizontally scaled easily. In our scenario the object detection service could using a model like MobileNet which has faster inference times, but the classifier service might be using a ResNet for classification which has slower inference times.<p>As we already know, a system is only as fast as the slowest component in the system. So in this example, we would need to create more replicas of the ResNet classifier service.<p>Now the model prediction endpoint and the web service communicate over the network. So they can be scaled independently if necessary. For instance, we might not choose to scale up the web component of a disease grader service, but we can increase the number of model replicas in the model serving solution instead (PyTorch serve for instance.) Also it is not necessary that the web components each have their unique instance of the model serving solution. They could all make requests to shared model serving solution instance.<h4 id=support-for-multiple-environments><a aria-label="Anchor link for: support-for-multiple-environments" class="header-anchor no-hover-padding" href=#support-for-multiple-environments><span aria-hidden=true class=link-icon></span></a> Support for multiple environments</h4><p>Now in this design itself, we don't specify whether the services are containers, pods in k8s or simple linux processes. As long as they communicate with each other on the message queue, it doesn't matter where they run.<p>This flexibility allows us to pursue multi-cloud architectures where different components could be running on different service clouds (some on GCP, some on AWS etc.). At the same time, this entire system could simply run on just a beefy laptop, albeit with some loss of throughput.<h2 id=conclusion><a aria-label="Anchor link for: conclusion" class="header-anchor no-hover-padding" href=#conclusion><span aria-hidden=true class=link-icon></span></a> Conclusion</h2><p>Message Queues act as a general communication layer between different cooperating web services. They enable asynchronous processing of requests, horizontal scaling at each layer and higher capacity for handling requests. These properties make them an excellent communication layer between different Machine Learning inference services.</section><div class=comments data-category=Announcements data-category-id=DIC_kwDOJyOcX84CYJbZ data-dark-theme=noborder_dark data-input-position=top data-lang=en data-lazy-loading=true data-light-theme=noborder_light data-mapping=pathname data-reactions-enabled=1 data-repo=arindas/arindas.github.io data-repo-id=R_kgDOJyOcXw data-strict=1 id=comments><script async src=https://arindas.github.io/js/giscus.min.js></script></div></article></main><div id=button-container><a href=#comments id=comments-button> <svg viewbox="0 0 20 20" fill=currentColor><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule=evenodd fill-rule=evenodd /></svg> </a><a href=# id=top-button> <svg viewbox="0 0 20 20" fill=currentColor><path d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z"/></svg> </a></div></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" rel="noopener noreferrer" href=https://arindas.github.io/atom.xml target=_blank> <img alt=feed src=https://arindas.github.io/social_icons/rss.svg title=feed> </a><li><a class="nav-links no-hover-padding social" rel="noopener noreferrer me" href=https://github.com/arindas/ target=_blank> <img alt=github src=https://arindas.github.io/social_icons/github.svg title=github> </a><li><a class="nav-links no-hover-padding social" rel="noopener noreferrer me" href=https://twitter.com/arind_das target=_blank> <img alt=twitter src=https://arindas.github.io/social_icons/twitter.svg title=twitter> </a><li><a class="nav-links no-hover-padding social" rel="noopener noreferrer me" href=https://fosstodon.org/@arindas target=_blank> <img alt=mastodon src=https://arindas.github.io/social_icons/mastodon.svg title=mastodon> </a></ul></nav><div class=credits><small> Powered by <a href=https://www.getzola.org target=_blank>Zola</a> & <a href=https://github.com/welpo/tabi target=_blank>tabi</a></small></div></section></footer><link href=https://arindas.github.io/katex.min.css rel=stylesheet><script defer src=https://arindas.github.io/js/katex.min.js></script>